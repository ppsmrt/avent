<!DOCTYPE html>
<html>
<head>
  <title>Admin - Employee Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #searchInput {
      padding: 8px;
      width: 300px;
      font-size: 16px;
      margin-bottom: 15px;
    }
    .employee-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .employee-info {
      display: flex;
      align-items: center;
    }
    .employee-card img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    /* Popup Form */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 300px;
      margin: 100px auto;
      border-radius: 8px;
    }
    .modal-content input {
      width: 100%;
      margin-bottom: 10px;
      padding: 6px;
    }
  </style>
</head>
<body>
  <h2>Employee Management (Admin/HR)</h2>
  <input type="text" id="searchInput" placeholder="Search by ID or name..." />
  <div id="employeeList"></div>

  <!-- Edit Employee Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <h3>Edit Employee</h3>
      <input type="text" id="editName" placeholder="Name">
      <input type="text" id="editDesignation" placeholder="Designation">
      <input type="number" id="editSickBalance" placeholder="Sick Balance">
      <input type="text" id="editProfilePhoto" placeholder="Profile Photo URL">
      <button id="saveBtn">Save</button>
      <button id="closeBtn" style="background:gray">Cancel</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyATZi32dliIzjOCIXcv1MbxOXhkNjogA6Q",
      authDomain: "aventattendance.firebaseapp.com",
      databaseURL: "https://aventattendance-default-rtdb.firebaseio.com/",
      projectId: "aventattendance",
      storageBucket: "aventattendance.appspot.com",
      messagingSenderId: "993022737242",
      appId: "1:993022737242:web:92c380107f73eb70ac1163"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const employeeListDiv = document.getElementById("employeeList");
    const searchInput = document.getElementById("searchInput");

    // Modal elements
    const editModal = document.getElementById("editModal");
    const editName = document.getElementById("editName");
    const editDesignation = document.getElementById("editDesignation");
    const editSickBalance = document.getElementById("editSickBalance");
    const editProfilePhoto = document.getElementById("editProfilePhoto");
    const saveBtn = document.getElementById("saveBtn");
    const closeBtn = document.getElementById("closeBtn");

    let allEmployees = {};
    let currentEditKey = null;

    // Load employees
    onValue(ref(db, "users"), (snapshot) => {
      allEmployees = snapshot.val() || {};
      renderEmployees();
    });

    // Search input listener
    searchInput.addEventListener("input", renderEmployees);

    function renderEmployees() {
      const searchQuery = searchInput.value.trim().toLowerCase();
      employeeListDiv.innerHTML = "";

      Object.entries(allEmployees).forEach(([key, empData]) => {
        let employeeId = "";
        let name = "";
        let designation = "";
        let photo = "";
        let sickBalance = 0;

        if (empData.employeeId) {
          // EMPxxx style
          employeeId = empData.employeeId;
          name = empData.name || "No Name";
          designation = empData.designation || "No Designation";
          photo = empData.profilePhoto || "images/default-avatar.png";
          sickBalance = empData.sickBalance || 0;
        } else if (empData.basicInfo) {
          // UID style
          employeeId = key;
          name = empData.basicInfo.name || "No Name";
          designation = empData.employmentDetails?.designation || "No Designation";
          photo = empData.basicInfo.profilePhoto || "images/default-avatar.png";
          sickBalance = empData.sickBalance || 0;
        } else {
          return;
        }

        // Search filter
        if (
          searchQuery &&
          !employeeId.toLowerCase().includes(searchQuery) &&
          !name.toLowerCase().includes(searchQuery)
        ) {
          return;
        }

        // Card
        const card = document.createElement("div");
        card.className = "employee-card";
        card.innerHTML = `
          <div class="employee-info">
            <img src="${photo}" alt="${name}">
            <div>
              <strong>${name}</strong><br>
              <small>${employeeId}</small><br>
              <span>${designation}</span>
            </div>
          </div>
          <button>Edit</button>
        `;

        // Edit button listener
        card.querySelector("button").addEventListener("click", () => {
          openEditModal(key, { name, designation, sickBalance, profilePhoto: photo });
        });

        employeeListDiv.appendChild(card);
      });
    }

    function openEditModal(empKey, emp) {
      currentEditKey = empKey;
      editName.value = emp.name;
      editDesignation.value = emp.designation;
      editSickBalance.value = emp.sickBalance;
      editProfilePhoto.value = emp.profilePhoto;
      editModal.style.display = "block";
    }

    // Save changes
    saveBtn.addEventListener("click", () => {
      if (!currentEditKey) return;

      const updatedData = {
        name: editName.value,
        designation: editDesignation.value,
        sickBalance: parseInt(editSickBalance.value, 10),
        profilePhoto: editProfilePhoto.value
      };

      update(ref(db, `users/${currentEditKey}`), updatedData)
        .then(() => {
          alert("Employee updated successfully!");
          editModal.style.display = "none";
        })
        .catch(err => {
          console.error("Update failed:", err);
          alert("Error updating employee.");
        });
    });

    // Close modal
    closeBtn.addEventListener("click", () => {
      editModal.style.display = "none";
    });

    window.onclick = function(event) {
      if (event.target == editModal) {
        editModal.style.display = "none";
      }
    };
  </script>
</body>
</html>